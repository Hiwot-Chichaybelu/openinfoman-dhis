<careServicesFunction xmlns="urn:ihe:iti:csd:2013" xmlns:csd="urn:ihe:iti:csd:2013" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:hfp="http://www.w3.org/2001/XMLSchema-hasFacetAndProperty" xmlns:xforms="http://www.w3.org/2002/xforms" xmlns:ev="http://www.w3.org/2001/xml-events" urn="urn:dhis.org:extract_from_dxf:v2.19">
  <description>
    <pre>
This extracts all organisation units matching the given facility conditions as a CSD facility entity.  
It also extracts all organisation units a CSD organization entity.  
In the case that a CSD facility entity is created, it will have as an organizational association to it's corresponding organization entity.
These two entities will have distinct entity IDs (UUIDs)

This Also creates SVS for relevant terminologies (e.g. Organisation Unit Groups and Levels )

Imports: DHIS2 metadata export of Organsation Units, Organisation Unit Group,  Organisation Unit Group Set, Organization Unit Level from DHIS2 2.19

This optionally processes DHIS2 Users as health workers (CSD Providers).
In order to do so, you will need to have included Users, UserRoles and UserAuthorityGroups in your DXF2 meta-data extract.

    </pre>
  </description>
  <definition>
    <xi:include parse="text" href="extract_from_dxf.xq"/>
  </definition>
  <xforms:model id="urn:dhis.org:extract_from_dxf:v2.19">
    <xforms:instance id="care-services-result">
      <csd:careSerivcesResponse id="" code="" content-type=""/>
    </xforms:instance>
    <xforms:instance id="http-post-request">
      <csd:requestParams>
        <dxf/>
        <groupCodes/>
        <levels/>
        <URL/>
        <oid/>
        <usersAreHealthWorkers/>
        <dataelementsAreServices/>
      </csd:requestParams>
    </xforms:instance>
    <xforms:instance id="http-post-response">
      <http:result xmlns:http="http://expath.org/ns/http-client" status="">
        <http:header name="X-CSD-Transaction-ID" value=""/>
        <http:body/>
      </http:result>
    </xforms:instance>
    <xforms:instance id="soap-request">
      <soap:Envelope xmlns:soap="http://www.w3.org/2003/05/soap-envelope">
        <soap:Header>
          <wsa:Action xmlns:wsa="http://www.w3.org/2005/08/addressing" soap:mustUnderstand="1">urn:ihe:iti:csd:2013:GetCareServicesRequest</wsa:Action>
          <wsa:MessageID xmlns:wsa="http://www.w3.org/2005/08/addressing"/>
          <wsa:ReplyTo xmlns:wsa="http://www.w3.org/2005/08/addressing" soap:mustUnderstand="1">
            <wsa:Address>http://www.w3.org/2005/08/addressing/anonymous</wsa:Address>
          </wsa:ReplyTo>
          <wsa:To xmlns:wsa="http://www.w3.org/2005/08/addressing" soap:mustUnderstand="1">{$LOCATION}</wsa:To>
        </soap:Header>
        <soap:Body>
          <csd:careServicesRequest urn="urn:dhis.org:extract_from_dxf:v2.19">
            <csd:requestParams>
              <dxf/>
              <groupCodes/>
              <levels/>
              <URL/>
              <oid/>
              <usersAreHealthWorkers/>
              <dataelementsAreServices/>
            </csd:requestParams>
          </csd:careServicesRequest>
        </soap:Body>
      </soap:Envelope>
    </xforms:instance>
    <xforms:instance id="soap-response">
      <soap:Envelope xmlns:soap="http://www.w3.org/2003/05/soap-envelope">
        <soap:Header>
          <wsa:Action xmlns:wsa="http://www.w3.org/2005/08/addressing" soap:mustUnderstand="1">urn:ihe:iti:csd:2013:GetCareServicesResponse</wsa:Action>
          <wsa:MessageID xmlns:wsa="http://www.w3.org/2005/08/addressing"/>
          <wsa:ReplyTo xmlns:wsa="http://www.w3.org/2005/08/addressing" soap:mustUnderstand="1">
            <wsa:Address>http://www.w3.org/2005/08/addressing/anonymous</wsa:Address>
          </wsa:ReplyTo>
          <wsa:RelatesTo xmlns:wsa="http://www.w3.org/2005/08/addressing"/>
        </soap:Header>
        <soap:Body>
          <csd:careServicesResponse/>
        </soap:Body>
      </soap:Envelope>
    </xforms:instance>
    <xforms:submission id="soap-submission" method="post" mediatype="application/soap+xml" ref="instance('soap-request')" resource="{$LOCATION}"/>
    <xforms:submission id="http-post-submission" method="post" mediatype="text/xml" ref="instance('http-post-request')" resource="{$LOCATION}/urn:dhis.org:extract_from_dxf:v2.19"/>
    <xforms:action ev:event="xforms-submit-done" id="http-post-prepare">
      <xforms:insert context="instance('http-post-response')/http:result/http:body" origin="instance('care-services-result')/csd:careServicesResponse/csd:result/*"/>
      <xforms:setValue bind="instance('http-post-response')/http:result/@status" value="instance('care-services-result')/csd:careServicesResponse/@code"/>
      <xforms:setValue bind="instance('http-post-response')/http:body/@content-type" value="instance('care-services-result')/csd:careServicesResponse/@content-type"/>
      <xforms:setValue bind="instance('http-post-response')/http:result/http:header[@name='X-CSD-Transaction-ID']/@value" value="instance('care-services-result')/csd:careServicesResponse/@id"/>
    </xforms:action>
    <xforms:action ev:event="xforms-submit-done" id="soap-prepare">
      <xforms:insert context="instance('soap-response')/soap:Envelope/soap:Body/csd:careServicesResponse/csd:result" origin="instance('care-services-result')/csd:careServicesRepsonse/csd:result/*"/>
      <xforms:insert context="instance('soap-response')/soap:Envelope/soap:Body/csd:careServicesResponse/@content-type" origin="instance('care-services-result')/csd:careServicesRepsonse/@content-type"/>
      <xforms:insert context="instance('soap-response')/soap:Envelope/soap:Body/csd:careServicesResponse/@code" origin="instance('care-services-result')/csd:careServicesRepsonse/@code"/>
      <xforms:setValue bind="instance('soap-response')/soap:Envelope/soap:Header/wsa:messageID" value="instance('soap-request')/csd:careServicesRequest/@id"/>
      <xforms:setValue bind="instance('soap-response')/soap:Envelope/soap:Header/wsa:relatesTo" value="instance('soap-request')/soap:Envelope/soap:Header/wsa:messageID"/>
    </xforms:action>
  </xforms:model>
  
  <csd:extension type="dhis2" urn="urn:openhie.org:openinfoman:adapter"/>
  <csd:extension type="simple_upload" urn="urn:openhie.org:openinfoman:adapter:dhis2:action"/>
</careServicesFunction>