<!DOCTYPE HTML>

<html >
  <head>
    <title>Care Services Discovery - Meta Data Loader</title>
    <base href="../../"/>
    <script type="text/javascript" src="../dhis-web-commons/javascripts/jQuery/jquery.min.js"></script>
    <script type="text/javascript" src="../dhis-web-commons/javascripts/jQuery/ui/jquery-ui.min.js"></script>
    <script type="text/javascript" src="../dhis-web-commons/javascripts/jQuery/ui/jquery.blockUI.js"></script>
    
<script type='text/javascript'>
$(function() {	
    var loc = window.location.href.substring(0, window.location.href.indexOf('/api/apps/csd-loader'));
    $('<link>').appendTo('head').attr({type : 'text/css', rel : 'stylesheet'}).attr('href', loc + '/dhis-web-commons/font-awesome/css/font-awesome.min.css');
    $('<link>').appendTo('head').attr({type : 'text/css', rel : 'stylesheet'}).attr('href', loc + '/dhis-web-commons/css/menu.css');
    $('<link>').appendTo('head').attr({type : 'text/css', rel : 'stylesheet'}).attr('href', loc + '/dhis-web-commons/javascripts/jQuery/ui/css/redmond/jquery-ui.css');
    $('<link>').appendTo('head').attr({type : 'text/css', rel : 'stylesheet'}).attr('href', loc + '/dhis-web-commons/css/light_blue/light_blue.css');
    $('<link>').appendTo('head').attr({type : 'text/css', rel : 'stylesheet'}).attr('href', loc + '/api/apps/csd-loader/datetimepicker-master/jquery.datetimepicker.css');

    window.dhis2 = window.dhis2 || {};
    dhis2.settings = dhis2.settings || {};
    dhis2.settings.baseUrl = loc.substring(loc.lastIndexOf('/')+1);



    
});
</script>
    
    <script type="text/javascript" src="../dhis-web-commons/javascripts/dhis2/dhis2.translate.js"></script>
    <script type="text/javascript" src="../dhis-web-commons/javascripts/dhis2/dhis2.menu.js"></script>
    <script type="text/javascript" src="../dhis-web-commons/javascripts/dhis2/dhis2.menu.ui.js"></script>
    <script type="text/javascript" src="apps/csd-loader/datetimepicker-master/build/jquery.datetimepicker.full.min.js"></script>
    <script type="text/javascript" src="apps/csd-loader/lib/CSD_medley.js.NOLOAD"></script>

<script type='text/javascript'>
var CSDLoader = function(form) {
    this.form = form;
    this.status = this.form.find( ".csdstatus" );
    this.BaseURL = window.location.href.substring(0, window.location.href.indexOf('/api/apps/csd-loader'));
    this.Log('BaseURL=' + this.BaseURL);
    this.BaseILRURL = this.BaseURL.substring(0,this.BaseURL.lastIndexOf('/'))+ '/ILR/CSD';   
    this.Log('Base ILR URL=' + this.BaseILRURL);
    this.xmlSerializer = new XMLSerializer();
    this.BindActions();
};

CSDLoader.prototype.Log = function(text) {
    console.log(text);
};

CSDLoader.prototype.UpdateStatus = function(text) {
    this.Log(text);
    if (!this.status) {
	return;
    }
    this.status.empty();
    this.status.text(text);    
};

CSDLoader.prototype.SetStatusAsLoading = function(isloading) {
    if (!this.status) {
	return;
    }
    if (isloading) {
	this.status.css('background-size', '16px 11px');
	this.status.css('background-repeat', 'no-repeat');
	this.status.css('background-image', 'url(../images/ajax-loader-bar.gif)');
	this.status.css('background-position', 'right center');
    } else {
	this.status.css('background-image', '');
    }
};

CSDLoader.prototype.Alert = function(text) {
    this.UpdateStatus(text);
    alert(text);
};

CSDLoader.prototype.GetServerTime = function () {
    this.Log('getting time from ' + this.BaseURL + '/api/metadata');
    var time = false;
    var options = {
	url: this.BaseURL + '/api/metadata',
	method: 'GET',
	type: 'GET',
	dataType: "xml",
	async: false,
	context: this,
	cache: false,
	data :
 	  {
	   assumeTrue:false
	  },

	error: $.proxy(function(xml) {
	    this.Log('could not fetch time');
	},this),
	success: $.proxy(function(xml) {
	    //extract time from	<metaData xmlns="http://dhis2.org/schema/dxf/2.0" created="2015-09-25T12:25:52.636+0000">
	    time = $(xml).find('metaData').attr('created');
	},this)
    };
    $.ajax(options);
    this.Log('metadata time = ' + time);
    return time;

};


CSDLoader.prototype.GetKeys = function() {
    this.Log('getting keys')
    var keys  = [];
    var options = {
	url: this.BaseURL + '/api/dataStore/CSD-Loader',
	method: 'GET',
	type: 'GET',
	dataType: "json",
	async: false,
	context: this,
	cache: false,
	error: $.proxy(function() {
	    this.Log('could not fetch last modified time');
	},this),
	success: $.proxy(function(json) {
	    //extract time from	<metaData xmlns="http://dhis2.org/schema/dxf/2.0" created="2015-09-25T12:25:52.636+0000">
	    keys = json;
	},this)
    };
    $.ajax(options);
    this.Log("Got Keys:" + keys.join());
    return keys;

};

CSDLoader.prototype.SetLastModified = function(time) {
    var method =  ($.inArray('LastExported',this.GetKeys()) >= 0)  ?  'PUT' : 'POST';
    this.Log('setting export to ' + time + ' using ' + method);
    var options = {
	url: this.BaseURL + '/api/dataStore/CSD-Loader/LastExported',
	method: method,
	contentType: 'application/json',
	type: method,
	dataType: "text",
	data : JSON.stringify({value : time}),
	context: this,
	cache: false,
	error: $.proxy(function() {
	    this.Log('could not set last modified time');
	},this),
	success: $.proxy(function(json) {
	    this.Log('set last modified time to ' + time);
	},this)
    };
    $.ajax(options);
    return time;
};


CSDLoader.prototype.FetchLastModified = function() {
    this.Log('getting last modfified');
    var time = false;
    var options = {
	url: this.BaseURL + '/api/dataStore/CSD-Loader/LastExported',
	method: 'GET',
	type: 'GET',
	dataType: "json",
	async: false,
	context: this,
	cache: false,
	error: $.proxy(function() {
	    this.Log('could not fetch last modified time');
	},this),
	success: $.proxy(function(json) {
	    //extract time from	<metaData xmlns="http://dhis2.org/schema/dxf/2.0" created="2015-09-25T12:25:52.636+0000">
	    time = json['value'];
	},this)
    };
    $.ajax(options);
    this.Log('last modified time = ' + time);
    return time;
};

CSDLoader.prototype.BindActions = function() {
    if (!this.form) {
	return;
    }

    this.form.click(  $.proxy(function(event) {
	//save the orgin of every click within this form so we can recover submission button
	$(this).data('clicked',$(event.target))
    },this));

    var lm  = this.form.find('input[name=lastmodified]');
    if (lm) {
	var lmt = this.FetchLastModified();
	this.Log('Last Exported ' + lmt);
	var options = {
	    format:'c',
	    startDate:'+2016/01/01'
	    };
	if (lmt) {
	    options['value']=new Date(lmt);
	}
	this.Log(JSON.stringify(options));
	lm.datetimepicker(options);
    }
    var alldata = this.form.find('select[name=alldata]');
    var lmc = this.form.find('.lastmodifiedcontainer');    
    if (alldata && lmc) {
	alldata.val('1');
	lmc.hide();
	alldata.change(function() {
	    if (alldata.val() == 0) {
		lmc.show();
	    } else{
		lmc.hide();
	    }
	});
    }

    
    this.form.submit( $.proxy(function( event ) {
	event.preventDefault();
	var action = $(this).data('clicked').attr('value');
	switch (action) {
	case 'Select':
	    this.UpdateSelection();
	    break;
	case 'Import':
	    this.ImportSelected();
	    break;
	case 'Export':
	    this.Export();
	    break;
	default:
	    this.Alert('Unrecognzied Action: ' + action);		
	}
		
    },this));


    this.form.find('select[name=docs]').change( $.proxy( function() {
        this.UpdateSelection();
    },this));

    this.form.find('select[name=org]').change( $.proxy( function() {
	this.UpdateSelection();
    },this));
};



CSDLoader.prototype.LoadDocs = function() {
    
    var docs = this.form.find('select[name=docs]');
    if (!docs) {
	return;
    }
    this.Log('getting docs');
    $.ajax({
	url: this.BaseILRURL + '/documents.json',
	contentType: 'application/json',
	dataType: "text",
	cache: false,
	context: this,
	error: $.proxy(function() {
	    this.Log('error on fetch');
	    this.UpdateStatus('Could not load the CSD documents.  You need to ensure the InterLinked Registry is running at ' + this.BaseILRURL);
	},this),
	success: $.proxy(function(json) {
	    this.Log('got documents' + json);
	    docs.empty();
	    docs.append("<option vaue=''>Select A Document</option>");
	    var doclist = $.parseJSON(json);
	    this.Log(doclist[0]);
	    $.each(doclist,
	           function(key,value) {
		       var id = key;
		       var name = key;
		       docs.append("<option value='" + id + "'>" + name + "</option>");
		   });
	    this.Log('updated docs dropdown');
	    this.UpdateSelection();
	},this)
    });
};
	  
CSDLoader.prototype.UpdateSelection = function() { 
    var doc = this.form.find('select[name=docs] option:selected').val();
    var url  = this.BaseILRURL + '/csr/' + doc + '/careServicesRequest/urn:ihe:iti:csd:2014:stored-function:organization-search';
    var selected = this.form.find('select[name=org] option:selected')
    var parentID = selected.val();
    var parentName = selected.text();
    var msg ="<csd:requestParams xmlns:csd='urn:ihe:iti:csd:2013'><csd:parent entityID='" + parentID + "'/></csd:requestParams>";
    this.Log('sending to ' + url + "\n" + msg);
    this.Log(url);
    $.ajax({
	method:'POST',
	type: 'POST',
	url:url,
	data:msg,
	contentType: 'text/xml',
	dataType: "xml",
	cache: false,
	context: this,
	error: $.proxy(function() {
	    this.Log('error on fetch');
	    this.Alert('Could not load the organisation units');
	},this),
	
	success: $.proxy(function(xml) {
	    this.Log('done');
            var select = this.form.find('[name=org]');
	    select.empty();
	    if (parentID) {
  	          select.append("<option value='" + parentID +"'>" + parentName + "</option>");	    
	    }
	    select.append("<option value=''></option>");
	    this.Log("Received\n" +  this.xmlSerializer.serializeToString(xml));
	    var logger = this.Log
	    $(xml).find("csd\\:organization,organization").each(
	        function() {
		    logger(this);
		    var id = $(this).attr('entityID');
		    var name = $(this).find('csd\\:primaryName,primaryName').text();
		    logger('Adding: ' + id + ' ' + name);
		    select.append("<option value='" + id + "'>" + name + "</option>");
		});
	    this.Log('updated dropdown');
	    return true;
	},this)
    });
   
};


CSDLoader.prototype.Export = function() {
    this.UpdateStatus('Beginning Export');
    var doUsers = this.form.find('select[name=users] option:selected').val() == '1' ? true : false;
    var groupCodes = '';
    $.each(this.form.find('input[name=group_codes]').val().split(","),
	function(key,value) {
	   groupCodes += "<groupCode>" + value + "</groupCode>";
	});
    var levels = '';
    var dhis2time = this.GetServerTime();
    this.form.find('input.level:checked').each( $.proxy(
      function(key,value) {
	   levels += "<level>" + value.value + "</level>";
      },this));
    var lmt = this.form.find('input[name=lastmodified]').val();
    var doall = this.form.find('select[name=alldata] option:selected').val();
    var data = 	  {
	   assumeTrue:false,
	   categoryOptions:true,
	   optionSets:true,
	   dataElementGroupSets:true,
	   userRoles: doUsers,
	   organisationUnits:true,
	   userGroups: doUsers,
	   organisationUnitGroups:true,
	   organisationUnitLevels:true,
	   categoryOptionGroupSets:true,
	   categoryCombos:true,
	   organisationUnitGroupSets:true,
	   options:true,
	   categoryOptionCombos:true,
	   dataSets:true,
	   dataElementGroups:true,
	   dataElements:true,
	   categoryOptionGroups:true,
	   categories:true,
	   users:doUsers	  	   
	  };
    console.log('Do all ' + doall);
    if (lmt && doall != 1) {
	data['lastUpdated'] = $.datepicker.formatDate('yy-mm-dd', new Date(lmt));
	
    }

    this.Log('Sending to DHIS2: ' + JSON.stringify(data));

    this.SetStatusAsLoading(true);
    $.ajax({
	url: this.BaseURL + '/api/metadata',
	method: 'GET',
	type: 'GET',
	context: this,
	data : data,
	dataType: 'text',
	error: $.proxy(function(xhr,status,error) {	    
	    this.Alert('Could not upload the metadata');
	    this.SetStatusAsLoading(false);
	    this.Log( status + "/" + error);
	    this.UpdateStatus('Data Export From DHIS2 Failed');
	    },this),
	success: $.proxy(function(xml) {
	    this.Log("Received\n" +   xml);
	    xml  = xml.replace(/\<(\?xml|(\!DOCTYPE[^\>\[]+(\[[^\]]+)?))+[^>]+\>/g, '');
	    this.UpdateStatus('Data Import To ILR Initiating');
	    this.SetStatusAsLoading(true);
	    var doc = this.form.find('select[name=docs] option:selected').val();
	    var url  = this.BaseILRURL + '/csr/' + doc + '/careServicesRequest/update/urn:dhis.org:extract_from_dxf:v2.19';
    
	    var msg =
		  "<csd:requestParams xmlns:csd='urn:ihe:iti:csd:2013'>\n"
	    	+ "   <dxf>" + xml +"</dxf>\n"
		+ "   <groupCodes/>\n"
		+ "   <levels>" + levels + "</levels>\n"
		+ "   <URL>"+ this.BaseURL +"</URL>\n"
		+ "   <oid/>\n"
		+ "   <usersAreHealthWorkers>" + (doUsers ? '1' : '0') + "</usersAreHealthWorkers>\n"
		+ "   <dataelementsAreServices/>\n"
		+ " </csd:requestParams>\n";
	    this.UpdateStatus('Publishing Data To ILR');
	    this.Log("Sending to " + url + "\n" + msg);
	    $.ajax({
		method:'POST',
		type: 'POST',
		url:url,
		data:msg,
		contentType: 'text/xml',
		dataType: "xml",
		context: this,
		cache: false,
		error: $.proxy(function(xhr,status,error) {
		    this.Alert('Failed To Send Data To ILR');
		    this.Log( + status + "/" + error);
		    this.SetStatusAsLoading(false);
		},this),
		success: $.proxy(function(xml) {
		    this.UpdateStatus('Sent Data For Import To ILR');
		    this.Log('Setting last modified time to ' + dhis2time);
		    this.SetLastModified(dhis2time);		    
		    this.SetStatusAsLoading(false);
		},this)
	    });
 	},this)
    });

};

CSDLoader.prototype.ImportSelected = function() {
    this.UpdateStatus('Beginning Data Import');
    var doc = this.form.find('select[name=docs] option:selected').val();
    var url  = this.BaseILRURL + '/csr/' + doc + '/careServicesRequest/urn:dhis.org:transform_to_dxf:v2.19';
    var selected = this.form.find('select[name=org] option:selected')
    var parentID = selected.val();
    var doUsers = this.form.find('select[name=users] option:selected').val() == '1' ? true : false;
    var msg =
      "<csd:requestParams xmlns:csd='urn:ihe:iti:csd:2013'>\n"
      +" <csd:organization entityID='" + parentID + "'/>\n"
      +" <processUsers value='" + (doUsers ? 'true' : 'false') + "'/>\n"
      +"</csd:requestParams>";
    this.UpdateStatus('Requesting Data From ILR');
    this.Log('SENDING to ' + url + "\n" + msg);
    $.ajax({
	method:'POST',
	type: 'POST',
	url:url,
	data:msg,
	contentType: 'text/xml',
	dataType: "xml",
	context: this,
	cache: false,
	error: function() {
	    this.Alert('Could not load the selected organisation units');
	    this.UpdateStatus('Request For Data From ILR Failed');
	},
	success: function(xml) {
	    this.UpdateStatus('Sending Data For Import To DHIS2');
	    this.Log("Received\n" +  this.xmlSerializer.serializeToString(xml));
	    $.ajax({
	        url: this.BaseURL + '/api/metadata',
	        method: 'POST',
	        type: 'POST',
		context: this,
		data:  this.xmlSerializer.serializeToString(xml),
		contentType: 'application/xml',
		error: function() {
		    this.Alert('Could not upload the metadata');
		    this.UpdateStatus('Data Import On DHIS2 Failed');},
		success: function(xmlResponse) {
		    this.Log("Received\n" +   xmlResponse);		    
		    this.UpdateStatus('Data Import On DHIS2 Initiated');
		}
		
	    });
	    }
        });
};


</script>

 
<script>
$(function() {	
    $("#tabs").tabs(); //{active: false});
    (new CSDLoader($("#csdimport" ))).LoadDocs();
    (new CSDLoader($("#csdexport" ))).LoadDocs();
});
</script>

  </head>
  <body>

      
      <div id="header" style="background-color: #276696; ">
	<img id="headerBanner"
	     src="staticContent/logo_banner"
	     onclick="window.location.href='dhis-web-dashboard-integration/index.action'"
	     style="cursor:pointer"
	     title="View home page"/>
	
	  <span
	      id="headerText"
	      onclick="window.location.href='dhis-web-dashboard-integration/index.action'"
	      style="cursor:pointer"
	      title="View home page">
	    DHIS 2
	    </span>

	  <div id="dhisDropDownMenu"></div>
      </div>
	  
      <div id='content' style="background-color: white;padding:2em; ">
	<p>
	  This application will query a InterLinked Registry
	  (a <a href="http://wiki.ihe.net/index.php?title=Care_Services_Discovery">Care Services Discover(CSD)</a>-compliant InfoManager) 
	  to import and export CSD  metadata into your DHIS2 instance.
	</p>

	<div id='tabs'>
	  <ul>
	    <li><a href="apps/csd-loader/index.html#tabs-2">CSD Export</a></li>
	    <li><a href="apps/csd-loader/index.html#tabs-1">CSD Import</a></li>
	  </ul>
	  <div id="tabs-2">
	    <h1>CSD Meta Data Exporter</h1>

	    <p>
	      The InterLinked Registry must support the optional "urn:dhis.org:transform_to_dxf:v2.19"  stored query.
	      This is provided in the <a href="https://github.com/openhie/openinfoman-dhis">OpenInfoMan-DHIS2 adapter</a>
	    </p>

	    <form id='csdexport' >
              <p>The CSD document on the InterLinked Registry on which to export data to</p>
    	      <label for='docs' >Document</label>
	      <select name='docs' >
		<option value=''>Select a Document</option>
	      </select>

	      <br/>
              <p>Load Health Workers as Users</p>
              <label for='users' >Users</label>
	      <select name='users' >
		<option value='0'>No</option>
		<option value='1'>Yes</option>
	      </select>
              <br/>
	      <p>Comma seperated list of the Organisation Unit Group Codes used to identify a facility</p>
	      <label for='group_codes' >Group Codes</label>
	      <input type='text' size='120' name='group_codes'/>
	      <br/>

	      <p>		   Levels used to identify a facility</p>
	      <label for='level1' >Levels</label>
	      <input type='checkbox' name='level1' value='1' class='level'/>1 		   
	      <input type='checkbox' name='level2' value='2' class='level'/>2
	      <input type='checkbox' name='level3' value='3' class='level'/>3
	      <input type='checkbox' name='level4' value='4' class='level'/>4
	      <input type='checkbox' name='level5' value='5' class='level'/>5
	      <input type='checkbox' name='level6' value='6' class='level'/>6
	      <input type='checkbox' name='level7' value='7' class='level'/>7
	      <input type='checkbox' name='level8' value='8' class='level'/>8
	      <input type='checkbox' name='level9' value='9' class='level'/>9 
	      <br/>

	      <p>Retrieve changes to metadata updates since</p>
	      <select name='alldata'>
		<option value='1'>All Data</option>
		<option value='0'>Only Changes Since:</option>
	      </select>
              <span class='lastmodifiedcontainer'>
                <input type="text" value="" name="lastmodified"/>
              </span>

              <p>Export into the InterLinked Registry</p>
	      <input type='submit' value='Export'/>
	      <p class='csdstatus' style='background-color: #eee; border: 1px solid #bbb; border-radius: 3px;	opacity: 0.85;    padding: 6px;'/>
	    </form>

	  </div>
	  <div id="tabs-1">
	    <h1>CSD Meta Data Importer</h1>
	    <p>
	      The InterLinked Registry must support the optional "urn:dhis.org:extract_from_dxf:v2.19" stored query.
	      This is provided in the <a href="https://github.com/openhie/openinfoman-dhis">OpenInfoMan-DHIS2 adapter</a>
	    </p>
	    

	    <h2>Load MetaData</h2>
	    <p>Access the InterLinked Registry and Load the MetaData</p>
	    <form id='csdimport' >
              <p>The CSD document on the InterLinked Registry on which to submit the Find Matching Services [ITI-73] transaction</p>
    	      <label for='docs' >Document</label>
	      <select name='docs'>
		<option value=''>Select a Document</option>
	      </select>



	      <br/>
              <p>Select the part of the organisation unit hierarchy to load</p>
	      <select name='org'>
		<option value=''></option>
	      </select>
	      <br/>	      
              <p>Load Health Workers as Users</p>
              <label for='users' >Users</label>
	      <select name='users' >
		<option value='0'>No</option>
		<option value='1'>Yes</option>
	      </select>
              <br/>
              <p>Load the selected organisation unit into DHIS2</p>
	      <input type='submit' value='Import'/>
	      <p class='csdstatus' style='background-color: #eee; border: 1px solid #bbb; border-radius: 3px;	opacity: 0.85;    padding: 6px;'/>
	    </form>

	  </div>
	</div>
		
		
      </div>
    </div>


  </body>
</html>
